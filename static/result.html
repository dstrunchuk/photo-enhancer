<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Результат</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="premium-bg">
  <div class="result-topbar">
    <button onclick="goBack()">← Назад</button>
  </div>

  <div class="result-content">
    <img id="toggleImage" src="" alt="Фото" class="result-img" onclick="openFullscreen()" />
    <button id="toggleBtn" onclick="toggleImage()">Показать ДО</button>
    <button class="download-btn" onclick="sendToTelegram()">Скачать в Telegram</button>
  </div>

  <div id="sending" style="display: none;" class="sending-overlay">
    <div class="sending-box">
      <div class="spinner"></div>
      <p>Отправляем фото в Telegram...</p>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();

    const beforeUrl = sessionStorage.getItem("previewImage");
    const afterUrl = sessionStorage.getItem("resultImage");
    const img = document.getElementById("toggleImage");
    const btn = document.getElementById("toggleBtn");

    let showingAfter = true;

    if (!afterUrl) {
      alert("⚠️ Не удалось загрузить фото. Попробуйте снова.");
      window.location.href = "index.html";
    } else {
      img.src = afterUrl;
    }

    function toggleImage() {
      showingAfter = !showingAfter;
      img.classList.add("fade");
      img.src = showingAfter ? afterUrl : beforeUrl;
      btn.innerText = showingAfter ? "Показать ДО" : "Показать ПОСЛЕ";
      setTimeout(() => img.classList.remove("fade"), 200);
    }

    function goBack() {
      if (Telegram.WebApp.platform === 'ios') {
        window.location.replace('index.html');
      } else {
        window.location.href = 'index.html';
      }
    }

    function openFullscreen() {
      const mode = showingAfter ? "after" : "before";
      window.location.href = `fullscreen.html?mode=${mode}`;
    }

    async function sendToTelegram() {
      const chatId = Telegram.WebApp.initDataUnsafe?.user?.id;
      const response = await fetch(afterUrl);
      const blob = await response.blob();

      const formData = new FormData();
      formData.append("file", blob, "ai-foto.jpg");
      formData.append("chat_id", chatId);

      const sendingIndicator = document.getElementById("sending");
      sendingIndicator.style.display = "block";

      try {
        const res = await fetch("/send_photo_upload", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (res.ok && data?.ok) {
          Telegram.WebApp.showAlert("✅ Фото отправлено в Telegram.");
        } else {
          Telegram.WebApp.showAlert("⚠️ Фото отправилось, но сервер вернул ошибку.");
        }
      } catch {
        Telegram.WebApp.showAlert("❌ Ошибка соединения с сервером.");
      } finally {
        sendingIndicator.style.display = "none";
      }
    }
  </script>
</body>
</html>